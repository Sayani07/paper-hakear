---
title: "Choosing an appropriate scalar transformation to normalise wpd"
author: "Sayani Gupta"
date: "28/01/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      eval = TRUE,
                      warning = FALSE,
                      message = FALSE)
knitr::read_chunk("example_transformations.R")
library(tidyverse)
library(readr)
library(ggplot2)
```

 - Data presented

Observations are generated from a N(0,1) distribution for each combination of $nx$ and $nfacet$ from the following sets: $nx = nfacet = \{2, 3, 5, 7, 14, 20, 31, 50\}$ to cover a wide range of levels from very low to moderately high. Each combination is being referred to as a _panel_. That is, data is being generated for each of the panels $\{nx = 2, nfacet = 2\}, \{nx = 2, nfacet = 3\}, \{nx = 2, nfacet = 5\},  \dots, \{nx = 50, nfacet = 31\}, \{nx = 50, nfacet = 50\}$. For each of the $64$ panels, $ntimes = 500$ observations are drawn for each combination of the categories. That is, if we consider the panel  $\{nx = 2, nfacet = 2\}$, $500$ observations are generated for each of the combination of categories from the panel, namely, $\{(1, 1), (1, 2), (2, 1), (2, 2)\}$. The values of $\lambda$ is set to $0.67$ and values of raw wpd is obtained.

 - How the distribution of the raw wpd (without any transformation for normalization) looks across nfacets and nx? Both shape and scale of the distribution changes for different nx and nfacet categories as could be seen in Figure \ref{fig:raw}.

```{r read}
N01 <- read_csv("simulations/raw/null_design_quantrans/data-agg/all_data_wpd_N01.csv")
```


```{r raw, fig.cap="Distribution of raw wpd is plotted across different nx and nfacet categories. Both shape and scale of the distribution changes for different nx and nfacet categories."}
N01 %>% 
  ggplot(aes(x = value)) + 
  geom_density(fill = "blue") +
  facet_grid(nx~nfacet,
             labeller = "label_both") + 
  scale_x_continuous(breaks = scales::breaks_extended(3)) + 
  xlab("raw wpd")
```


 - Plot the values of raw wpd against nx*nfacet to see the rough relationship (\ref{fig:quadratic}).

```{r quadratic, fig.cap = "The raw wpd is plotted against nx*nfacet and the blue line represents the median of the multiple values for each nx*nfacet levels."}
N01 %>% 
  ggplot(aes(x=nx*nfacet, y = value)) +
  geom_point() + stat_summary(fun=median, geom="line", aes(group=1), color = "blue") + xlab("nx*nfacet") + ylab("raw wpd")

```

**Current attempt**

- Fit a log-linear model of median(values) to log(nx*nfacet) as discussed today. The fit is pretty good and the summary of the fit is shown below.

```{r, echo = TRUE}
N01_median <- N01 %>% 
  group_by(nx*nfacet) %>% 
  summarise(actual = median(value))

fit_lm2 <- lm(actual ~ poly(log(`nx * nfacet`) ,1, raw=TRUE), data = N01_median)
summary(fit_lm2)
```

- Make it a horizontal line so that the values are not affected by 
nx\*nfacet by plotting $wpd_{norm} = (value - intercept)/log(nx*nfacet)$ against log(nx*nfacet). The line actually becomes horizontal after this transformation as could be seen in Figure \ref{fig:horizontal}.


```{r horizontal, fig.cap = "wpd_{norm} is plotted against log(nx*nfacet). The relationship changed from being non-linear to almost horizontal. The horizontal line would imply that median values of wpd are unaffected by the value of nx* nfacet."}

intercept <- fit_lm2$coefficients[1]
slope <- fit_lm2$coefficients[2]

N01 %>% 
  ggplot(aes(x=log(nx*nfacet), y = (value - intercept)/log(nx*nfacet))) +
  geom_point() + stat_summary(fun=median, geom="line", aes(group=1), color = "blue")  +
  ylab("wpd_norm = (wpd - intercept)/log(nx*nfacet)")

```
- See distribution of the transformed variable $wpd_{norm}$ across nx and nfacets. For higher values of nx and nfacet, the distribution is similar, but not for lower values.

```{r, fig.cap = "The distribution of the transformed wpd is plotted. The shape and the scale of the distribution still changes across different nx and nfacet levels, but seems uniform for higher levels." }
N01 %>% 
  ggplot(aes(x = (value - intercept)/(log(nx*nfacet)))) + 
  geom_density(fill = "blue") +
  facet_grid(nx~nfacet,
             labeller = "label_both") + 
  xlab("wpd") +
  scale_x_continuous(breaks = scales::breaks_extended(3)) +
  xlab("wpd_norm = (wpd - intercept)/(log(nx*nfacet)")


```

It was suggested that we can do permutation normalization for smaller levels and this scalar transformation for higher levels as this transformation is working well when both nx and nfacet are high enough. There are potentially two problems if we follow that approach:

- Since the normalized wpd's for different harmonies will be on different scales, harmonies could not be ranked even for the same objects (households) to select the most important household for that object - which was essentially the idea. Hence, the normalized wpd's would have to be brought on the same scale irrespective of the approach (whether permutation approach or scalar transformation).


- We have to think about the cut-offs, that is, for which level of nx and nfacets, we want to move to scalar transformation like this.


