---
title: "Compare permutation and scalar transformation approaches on simulated and real data"
author: "Sayani Gupta"
output:
  bookdown::pdf_book:
    #base_format: rticles::asa_article
    fig_height: 5
    fig_width: 8
    fig_caption: yes
    dev: "pdf"
    toc: FALSE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      eval = TRUE,
                      warning = FALSE,
                      message = FALSE)
knitr::read_chunk("example_transformations.R")
library(tidyverse)
library(readr)
library(ggplot2)
library(here)
```


# Simulated data


## Data generation

Observations are generated from a Gamma(2,1) distribution for each combination of $nx$ and $nfacet$ from the following sets: $nx = nfacet = \{2, 3, 5, 7, 14, 20, 31, 50\}$ to cover a wide range of levels from very low to moderately high. Each combination is being referred to as a _panel_. That is, data is being generated for each of the panels $\{nx = 2, nfacet = 2\}, \{nx = 2, nfacet = 3\}, \{nx = 2, nfacet = 5\},  \dots, \{nx = 50, nfacet = 31\}, \{nx = 50, nfacet = 50\}$. For each of the $64$ panels, $ntimes = 500$ observations are drawn for each combination of the categories. That is, if we consider the panel  $\{nx = 2, nfacet = 2\}$, $500$ observations are generated for each of the combination of categories from the panel, namely, $\{(1, 1), (1, 2), (2, 1), (2, 2)\}$. The values of $\lambda$ is set to $0.67$ and values of raw wpd $wpd_{raw}$ is obtained.


```{r raw, fig.cap = "Distribution of raw wpd is plotted across different nx and nfacet categories. Both shape and scale of the distribution changes for different nx and nfacet categories."}
G21 <- read_rds("simulations/raw/null_design_quantrans/data-agg/all_data_wpd_Gamma21.rds")

G21 %>% 
  ggplot(aes(x = value)) + 
  geom_density(fill = "blue") +
  facet_grid(nx~nfacet,
             labeller = "label_both") + 
  scale_x_continuous(breaks = scales::breaks_extended(3)) + 
  xlab("raw wpd")
```

 - Plot the values of raw wpd against nx*nfacet to see the rough relationship (\ref{fig:quadratic}).

```{r quadratic, fig.cap = "The raw wpd is plotted against nx*nfacet and the blue line represents the median of the multiple values for each nx*nfacet levels."}
G21 %>% 
  ggplot(aes(x=nx*nfacet, y = value)) +
  geom_point() + stat_summary(fun=median, geom="line", aes(group=1), color = "blue") + xlab("nx*nfacet") + ylab("raw wpd")

```

## Scalar transformation approach to normalisation

### Linear model

A log-linear model is fitted to see how the values of $wpd_{raw}$ changes with the values of $nx$ and $nfacet$. The model is of the form $$y = a+b*log(x) +e$$, where $y = median(wpd_{raw})$ and $x = nx*nfacet$. $wpd_{lm}$ is a transformation on $wpd_{raw}$ which should be designed to remove the effect of $nx*nfacet$ on $wpd_{raw}$ and thus is defined as follows:
$wpd_{lm} = wpd_{raw} - a - b*log(nx*nfacet)$


```{r wpd-lm-horizontal,echo=FALSE, fig.caption = "$wpd_{lm}$ is platted again log(nx*nfacet) and this transformation leads to median($wpd_{lm}$) to having almost no relationship with log(nx*nfacet)"}

G21 <- read_rds(here("simulations/raw/null_design_quantrans/data-agg/all_data_wpd_Gamma21.rds"))

G21_median <- G21 %>% 
  group_by(nx*nfacet) %>% 
  summarise(actual = median(value))


# fit model median to log(nx*nfacet)
fit_lm2 <- lm(actual ~ poly(log(`nx * nfacet`) ,1, raw=TRUE), data = G21_median)

summary(fit_lm2)

intercept <- fit_lm2$coefficients[1]
slope <- fit_lm2$coefficients[2]


G21 %>% 
  ggplot(aes(x=log(nx*nfacet), y = (value - intercept - slope*log(nx*nfacet)))) +
  geom_point() + stat_summary(fun=mean, geom="line", aes(group=1), color = "blue") +
  ylab("wpd_lm = wpd_raw - a - b*log(nx*nfacet)")
```

```{r wpd-lm-dist, fig.cap = " The distribution of $wpd_{lm}$ is plotted. The distributions are more similar across higher  nx and nfacet and are different for smaller nx and nfacet."}

G21_lm <- G21 %>% 
  mutate(wpd_lm =  (value - intercept - slope*log(nx*nfacet)))

G21_lm %>% 
  ggplot() +
  geom_density(aes(x = wpd_lm), 
                   fill = "blue") +
  facet_grid(nx~nfacet,
             labeller = "label_both") +
  theme(legend.position = "bottom") 
```  


### Generalised linear model

In the earlier approach, $wpd_{raw} \in R$, whereas,  $0 \leq wpd_{raw}\leq 1$ since it is a JS distance. Also, JSD follows a Chi-square distribution, which could be considered as a Gamma distribution. Hence, to restrict the range of the measure between 0 and 1, and deviate from the normality assumption of the response variable in a OLS approach, we fit a generalized linear model (GLM) with the error distributed as a gamma distribution and link function as "inverse". Hence, the model is of the form  $$1/y = a+b*log(x) +e$$, where $y = median(wpd_{raw})$ and $x = nx*nfacet$. Again, $wpd_{glm}$ is a transformation on $wpd_{raw}$ which should be designed to remove the effect of $nx*nfacet$ on $wpd_{raw}$ and thus is defined as follows:
$wpd_{glm} = 1/wpd_{raw} - a - b*log(nx*nfacet)$.

Please note:

- subtracting the intercept brings the location of the transformed variable to 0 for either case
- heterogeneity is higher for this case after normalization as compared to the earlier one.

```{r wpd-glm-horizontal, echo = FALSE, fig.caption = "$wpd_{glm}$ is plotted against log(nx*nfacet) and this transformation leads to the median of $wpd_{glm}$ to have no relationship with log(nx*nfacet)"}

G21 <- read_rds(here("simulations/raw/null_design_quantrans/data-agg/all_data_wpd_Gamma21.rds"))

G21_median <- G21 %>% 
  group_by(nx*nfacet) %>% 
  summarise(actual = median(value))



glm_fit <- glm(actual ~ log(`nx * nfacet`),
              family = Gamma(link = "inverse"),
              data = G21_median)

intercept <- glm_fit$coefficients[1]
slope <- glm_fit$coefficients[2]


# checking the fit of the residuals from glm fit

# fitted_glm <- fitted(glm_fit, type = "response")
# residuals <- residuals.glm(glm_fit, type = "response")
# hist(residuals)


#h = augment(glm_fit)
# ggplot(h) +
#   geom_histogram(aes(x = .resid))


# residual <- G21_median$actual  - fitted_glm
# 
# hist(residual)



G21 %>% 
  ggplot(aes(x=log(nx*nfacet),
             y = (value - (1/(intercept + slope*log(nx*nfacet)
                    )
                    )
             )
  )
  ) +
  geom_point() + stat_summary(fun=mean, geom="line", aes(group=1), color = "blue") + 
  ylab("wpd_glm = 1/wpd_raw - a - b*log(nx*nfacet)")
```


```{r wpd-glm-dist, fig.cap = " The distribution of $wpd_{glm}$ is plotted. The distributions are more similar across higher nx and nfacet and dissimilar for fewer nc and nfacets."}

G21_glm <- G21 %>% 
  mutate(wpd_glm =  (value - (1/(intercept + slope*log(nx*nfacet)
                    )
                    )
             ),
         wpd_glm_trans = ((wpd_glm*300)))

G21_glm %>% 
  ggplot() +
  geom_density(aes(x = wpd_glm), 
                   fill = "blue") +
  facet_grid(nx~nfacet,
             labeller = "label_both") +
  theme(legend.position = "bottom") 
```


The measure $wpd_{glm}$ seems to follow a normal distribution.

```{r}
ggplot(G21_glm) +
  geom_histogram(aes(x = wpd_glm))


p <- ggplot(G21_glm, aes(sample = wpd_glm))
p + stat_qq() + stat_qq_line()

# G21_glm <- G21 %>% 
#     mutate(wpd_glm =  (value - (1/(intercept + slope*log(nx*nfacet)
#     )
#     )
#     ),
#     wpd_glm_trans = 300*(wpd_glm))

 G21_glm$wpd_glm_trans %>% 
   range()

```  

## Permutation approach to normalisation

The simulated data for each of the panels is permuted/shuffled $nperm = 200$ times and for each of those permutations $wpd_{norm}$ is computed as follows: $wpd_{perm} =  (wpd_{raw} - mean(wpd_{raw}))/sd(wpd_{raw})$
. This is done so that the distribution of the normalised measure $wpd_{norm}$ has the same mean and standard deviation across different nx and nfacet.

Please note that standardizing the variable $wpd_{perm}$ in this approach leads to $location = 0$ and $scale = 1$ for this variable.


```{r wpd-permutation-dist, fig.cap = " The distribution of $wpd_{permutation}$ is plotted. The distributions are more similar across different nx and nfacet (specially for small nx and nfacet) but this approach has the downside of more computational time."}

G21_permutation <- read_rds("simulations/norm/null_design_quantrans_nperm/data-agg/all_data_wpd_Gamma21.rds") %>%
  rename("wpd_permutation" = "value") %>% 
  mutate(perm_trans =
           (
             (wpd_permutation - min(wpd_permutation))/
                (
                  max(wpd_permutation) - min(wpd_permutation)
                )
             )
           )


G21_permutation %>% 
    ggplot() +
  geom_density(aes(x = perm_trans), 
                   fill = "blue") +
  facet_grid(nx~nfacet,
             labeller = "label_both") +
  theme(legend.position = "bottom") 
```  

## Bringing them both to the same scale

We see that the transformation through the modeling approach leads to very similar distribution across high $nx$ and $nfacet$ (higher than 7) and not so much for lower $nx$ and $nfacet$. Hence, the computational load of permutation approach could be alleviated by using the modeling approach for the higher $nx$ and $nfacet$, however, it is important that we use the permutation approach for lower $nx$ and $nfacet$. However, it is  difficult to compare the transformed $wpd$ from both of these approaches, since each of the variables is measured on a different scale (each of them have location 0). The transformed variables from the two approaches could be brought to the same scale so that for smaller categories, permutation approach is used and for larger categories, we can stick to modeling approach. These could be done through the following:

 - Converting each scale to have the same lower and upper levels
 - Standardizing the variables and expressing scores at standard deviation units

- making the range of both the variables same (additional advantage that we can have a bound for the normalised measure which could be compared across normalizing approaches and data sets.)

```{r dist-new-same-scale-link, fig.cap="wpd_permutation and wpd_lm are in very different scale and could not be plotted together without transforming further. Whereas wpd_permutation and wpd_glm could be plotted together as they at least have the same location. Are they on the same scale though? Can they be compared?"}

# 
# G21_permutation <- read_rds("simulations/norm/null_design_quantrans_nperm/data-agg/all_data_wpd_Gamma21.rds") %>%
#   rename("wpd_permutation" = "value")
# 
# 
# G21_model_data <- G21 %>%
#   mutate(model =
#            ((1/value)
#                   - intercept -
#                     slope*log(nx*nfacet))/slope) %>%
#   mutate(model_trans =
#            (model - mean(model))/sd(model))

# G21_model_data$model %>% summary()

G21_all_data <- G21_permutation %>% 
  left_join(G21_lm, by = c("nx", "nfacet", "perm_id")) %>% 
  left_join(G21_glm, by = c("nx", "nfacet", "perm_id")) %>% 
  pivot_longer(cols = c(3, 10),
               names_to = "type_estimate",
               values_to = "value_estimate")
G21_all_data$type_estimate = factor(G21_all_data$type_estimate , levels = c( "wpd_permutation", "wpd_glm_trans"))


G21_all_data %>% 
  filter(type_estimate %in% c("wpd_glm_trans", "wpd_permutation")) %>% 
  ggplot() +
  geom_density(aes(x = value_estimate, 
                   fill = type_estimate)) +
  facet_grid(nx~nfacet,
             labeller = "label_both") +
  theme(legend.position = "bottom") +
  scale_fill_manual(values = c("#999999",  "#D55E00")) +
  xlab("wpd_norm2")

# G21_all_data %>% 
#   filter(type_estimate %in% c("wpd_permutation", "wpd_glm")) %>% 
#   ggplot() +
#   geom_density(aes(x = value_estimate, 
#                    fill = type_estimate), 
#                alpha = 0.7) +
#   facet_grid(nx~nfacet,
#              labeller = "label_both") +
#   theme(legend.position = "bottom") +
#   scale_fill_manual(values = c("#CC79A7", "#0072B2")) +
#   xlab("wpd_norm2")

# are scales same
# 
# G21_model_data %>%
#   group_by(nx, nfacet) %>% 
#   summarize(sd_model = sd(model))
#   
# G21_all_data %>%
#   filter(type_estimate == c("perm_trans")) %>% 
#   select(value_estimate) %>% 
#   range()
# 
# G21_all_data %>%
#   filter(type_estimate == c("wpd_glm_trans")) %>% 
#   select(value_estimate) %>% 
#   range()
```


Questions:

 1. Does the approach of $wpd_{glm}$ looks correct?

 2. Are $wpd_{glm}$ and $wpd_{permuation}$ be compared from this plot or both should be brought to the scale 1 for comparison?

 3. Forcing same range (0,1) to both $wpd_{glm}$ and $wpd_{permutation}$ could be obtained by using the transformation
$(z- z_{min})/ (z_{max} - z_{min})$. This could be used for the permutation approach. But the modeling approach would only have one value of $wpd_{raw}$ for a panel in practice, how to scale the values in the modeling approach so that they are within 0 and 1?


```{r variance}
#glm-wpd-sd
glm_wpd_sd <- G21_glm$wpd_glm %>% sd
#permutation-wpd_sd
glm_wpd_sd <- G21_permutation$wpd_permutation %>% sd
#lm-wpd_sd
G21_lm$wpd_lm %>% sd
```
<!-- In Figure \ref{fig:dist-new-approx}, we see that the distribution of $wpd_{norm2} = wpd_{raw} - b*log(nx*nfacet)$ is similar when normalised with true or approximate estimate of b. Moreover, the distributions are pretty similar across different nx and nfacet. -->

<!-- ```{r dist-new-approx, echo = FALSE, fig.cap = " The distribution of $wpd_{norm2}$ is plotted for approximate estimate of b. The distributions are similar when plotted against true and approximate estimate and b."} -->

<!-- G21 <- read_rds(here("simulations/raw/null_design_quantrans/data-agg/all_data_wpd_Gamma21.rds")) -->

<!-- G21_median <- G21 %>%  -->
<!--   group_by(nx*nfacet) %>%  -->
<!--   summarize(actual = median(value)) -->


<!-- # fit model median to log(nx*nfacet) -->
<!-- fit_lm2 <- lm(actual ~ poly(log(`nx * nfacet`) ,1, raw=TRUE), data = G21_median) -->

<!-- summary(fit_lm2) -->

<!-- intercept <- fit_lm2$coefficients[1] -->
<!-- slope <- fit_lm2$coefficients[2] -->


<!-- G21 %>%  -->
<!--   ggplot(aes(x=log(nx*nfacet), y = (value - slope*log(nx*nfacet)))) + -->
<!--   geom_point() + stat_summary(fun=mean, geom="line", aes(group=1), color = "blue")  -->


<!-- G21_permutation <- read_rds("simulations/norm/null_design_quantrans_nperm/data-agg/all_data_wpd_Gamma21.rds") %>%  -->
<!--   rename("wpd_permutation" = "value") -->

<!-- G21_all_data <- G21 %>%  -->
<!--   mutate(wpd_exact_est = (value - slope*log(nx*nfacet)), -->

<!--                           wpd_approx_est = (value - 0.0027*log(nx*nfacet))) %>%  -->
<!--   pivot_longer(cols = 5:6, -->
<!--                names_to = "type_estimate", -->
<!--                values_to = "value_estimate") -->

<!-- G21_all_data %>%  -->
<!--   ggplot() + -->
<!--   geom_density(aes(x = value_estimate,  -->
<!--                    fill = type_estimate),  -->
<!--                alpha = 0.5) + -->
<!--   facet_grid(nx~nfacet, -->
<!--              labeller = "label_both") + -->
<!--   theme(legend.position = "bottom") + -->
<!--   scale_fill_manual(values = c("#0072B2", "#D55E00", "#CC79A7")) + -->
<!--   xlab("wpd_norm2") -->
<!-- ``` -->

  